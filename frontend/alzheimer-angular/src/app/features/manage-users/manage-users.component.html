<div class="manage-users">
  <!-- Page header -->
  <header class="page-header">
    <div class="header-text">
      <h1 class="page-title">Manage Users</h1>
      <p class="page-subtitle">View and manage all profiles within your care network.</p>
    </div>
    <div class="header-tabs">
      @for (tab of tabs; track tab.id) {
        <button
          type="button"
          class="tab-pill"
          [class.tab-pill--active]="activeTab() === tab.id"
          (click)="onTabChange(tab.id)"
        >
          {{ tab.label }}
        </button>
      }
    </div>
  </header>

  <!-- Stat cards -->
  <div class="stats-grid">
    @for (stat of stats(); track stat.label) {
      <div class="stat-card glass-card">
        <div class="stat-card__icon" [ngClass]="stat.iconBg">
          <i class="pi" [ngClass]="stat.icon"></i>
        </div>
        <div class="stat-card__body">
          @if (stat.trendUp !== null) {
            <span
              class="stat-trend"
              [class.stat-trend--up]="stat.trendUp"
              [class.stat-trend--down]="!stat.trendUp"
            >
              {{ stat.trend }}
            </span>
          } @else {
            <span class="stat-trend stat-trend--neutral">{{ stat.trend }}</span>
          }
          <span class="stat-label">{{ stat.label }}</span>
          <span class="stat-value">{{ stat.value }}</span>
        </div>
      </div>
    }
  </div>

  <!-- Insights Section -->
  <div class="insights-grid">
    <!-- User Distribution -->
    <div class="insight-card glass-card">
      <div class="insight-card__header">
        <h3 class="insight-title">User Distribution</h3>
        <p class="insight-subtitle">Roles within your network</p>
      </div>
      <div class="insight-card__body">
        <p-meterGroup [value]="meterData()" labelPosition="start" />
      </div>
    </div>

    <!-- Registration Trends -->
    <div class="insight-card glass-card">
      <div class="insight-card__header">
        <h3 class="insight-title">Registration Trends</h3>
        <p class="insight-subtitle">Growth over the last 6 months</p>
      </div>
      <div class="insight-card__body chart-container">
        <p-chart type="line" [data]="chartData()" [options]="chartOptions" height="120px" />
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-overlay">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Loading patient data from microservice...</p>
    </div>
  } @else if (errorMessage()) {
    <div class="error-banner">
      <div class="error-banner__content">
        <i class="pi pi-exclamation-circle"></i>
        <span>{{ errorMessage() }}</span>
      </div>
      <p-button label="Retry Connection" icon="pi pi-refresh" severity="danger" size="small" [text]="true" (onClick)="loadPatients()" />
    </div>
  }


  <!-- Feedback Toast -->
  <p-toast />

  <!-- Confirmation Dialog -->
  <p-confirmDialog />

  <!-- Action Menu -->
  <p-menu #menu [model]="userMenuItems" [popup]="true" appendTo="body" />

  <!-- Edit User Dialog -->
  <p-dialog 
    header="Edit User Information" 
    [visible]="showEditDialog()" 
    (visibleChange)="showEditDialog.set($event)"
    [modal]="true" 
    [style]="{ width: '400px' }" 
    [draggable]="false"
    [resizable]="false"
    class="edit-dialog"
  >
    @if (editingUser()) {
      <div class="dialog-content">
        <div class="input-group">
          <label for="firstName">First Name</label>
          <input 
            pInputText 
            id="firstName" 
            [(ngModel)]="editingUser()!.firstName" 
            placeholder="Enter first name"
          />
        </div>
        <div class="input-group">
          <label for="lastName">Last Name</label>
          <input 
            pInputText 
            id="lastName" 
            [(ngModel)]="editingUser()!.lastName" 
            placeholder="Enter last name"
          />
        </div>
        <div class="input-group">
          <label for="age">Age</label>
          <p-inputNumber 
            id="age" 
            [(ngModel)]="editingUser()!.age" 
            [min]="0" 
            [max]="150"
            placeholder="Enter age"
          />
        </div>
      </div>
    }
    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button 
          label="Cancel" 
          [text]="true" 
          severity="secondary"
          (onClick)="showEditDialog.set(false)" 
        />
        <p-button 
          label="Save Changes" 
          icon="pi pi-check" 
          [loading]="isUpdating()" 
          (onClick)="savePatient()" 
        />
      </div>
    </ng-template>
  </p-dialog>

  <!-- User Directory -->
  <section class="directory-section">
    <div class="directory-header">
      <div class="header-main">
        <h2 class="directory-title">Network Directory</h2>
        <span class="directory-count">{{ total() }} records found</span>
      </div>
      <div class="directory-actions">
        <p-button
          label="Filter"
          icon="pi pi-filter"
          styleClass="p-button-outlined p-button-secondary p-button-sm border-round-xl"
          (onClick)="onFilter()"
        />
        <p-button
          label="Export"
          icon="pi pi-download"
          styleClass="p-button-outlined p-button-secondary p-button-sm border-round-xl"
          (onClick)="onExport()"
        />
      </div>
    </div>

    <div class="directory-table-wrap">
      <table class="directory-table">
        <thead>
          <tr>
            <th>Identity</th>
            <th>Contact</th>
            <th>Network Role</th>
            <th>Status</th>
            <th>Last Seen</th>
            <th class="text-right">Manage</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users(); track user.id) {
            <tr>
              <td>
                <div class="user-cell">
                  <p-avatar
                    [image]="user.avatar"
                    [label]="user.avatar ? '' : getInitials(user.name)"
                    shape="circle"
                    size="large"
                    [styleClass]="'user-avatar-premium ' + (user.avatar ? '' : user.avatarBg)"
                  />
                  <div class="user-info-stack">
                    <span class="u-name">{{ user.name }}</span>
                    <span class="u-id">#{{ user.id.substring(0,8) }}</span>
                  </div>
                </div>
              </td>
              <td>
                <div class="contact-block">
                   <span class="u-email">{{ user.email }}</span>
                </div>
              </td>
              <td>
                <p-tag 
                  [value]="user.role" 
                  [severity]="user.role === 'Patient' ? 'warning' : (user.role === 'Caregiver' ? 'info' : 'success')"
                  [rounded]="true"
                  styleClass="role-tag-premium"
                />
              </td>
              <td>
                <div class="status-indicator" [class.online]="user.status === 'Active'">
                  <span class="pulse-dot" *ngIf="user.status === 'Active'"></span>
                  <span class="status-text">{{ user.status }}</span>
                </div>
              </td>
              <td><span class="activity-text">{{ user.lastActivity }}</span></td>
              <td class="text-right">
                <button 
                  type="button" 
                  class="premium-action-btn" 
                  (click)="activeUser = user; menu.toggle($event)"
                >
                  <i class="pi pi-ellipsis-h"></i>
                </button>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="pagination-bar">
      <div class="pagination-info">
        Displaying <b>{{ first() + 1 }}</b> - <b>{{ first() + rows() }}</b> of <b>{{ total() }}</b> members
      </div>
      <div class="pagination-controls-premium">
        <button [disabled]="first() === 0" (click)="prevPage()"><i class="pi pi-chevron-left"></i></button>
        <button class="active">1</button>
        <button>2</button>
        <button [disabled]="first() + rows() >= total()" (click)="nextPage()"><i class="pi pi-chevron-right"></i></button>
      </div>
    </div>
  </section>

</div>
