<div class="manage-users">
  <!-- Page header -->
  <header class="page-header">
    <div class="header-text">
      <h1 class="page-title">Manage Users</h1>
      <p class="page-subtitle">View and manage all profiles within your care network.</p>
    </div>
    <div class="header-tabs">
      @for (tab of tabs; track tab.id) {
        <button
          type="button"
          class="tab-pill"
          [class.tab-pill--active]="activeTab() === tab.id"
          (click)="onTabChange(tab.id)"
        >
          {{ tab.label }}
        </button>
      }
    </div>
  </header>

  <!-- Stat cards -->
  <div class="stats-grid">
    @for (stat of stats(); track stat.label) {
      <div class="stat-card glass-card">
        <div class="stat-card__icon" [ngClass]="stat.iconBg">
          <i class="pi" [ngClass]="stat.icon"></i>
        </div>
        <div class="stat-card__body">
          @if (stat.trendUp !== null) {
            <span
              class="stat-trend"
              [class.stat-trend--up]="stat.trendUp"
              [class.stat-trend--down]="!stat.trendUp"
            >
              {{ stat.trend }}
            </span>
          } @else {
            <span class="stat-trend stat-trend--neutral">{{ stat.trend }}</span>
          }
          <span class="stat-label">{{ stat.label }}</span>
          <span class="stat-value">{{ stat.value }}</span>
        </div>
      </div>
    }
  </div>

  <!-- Insights Section -->
  <div class="insights-grid">
    <!-- User Distribution -->
    <div class="insight-card glass-card">
      <div class="insight-card__header">
        <h3 class="insight-title">User Distribution</h3>
        <p class="insight-subtitle">Roles within your network</p>
      </div>
      <div class="insight-card__body">
        <p-meterGroup [value]="meterData()" labelPosition="start" />
      </div>
    </div>

    <!-- Registration Trends -->
    <div class="insight-card glass-card">
      <div class="insight-card__header">
        <h3 class="insight-title">Registration Trends</h3>
        <p class="insight-subtitle">Growth over the last 6 months</p>
      </div>
      <div class="insight-card__body chart-container">
        <p-chart type="line" [data]="chartData()" [options]="chartOptions" height="120px" />
      </div>
    </div>
  </div>

  @if (loading()) {
    <div class="loading-overlay">
      <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
      <p>Loading patient data from microservice...</p>
    </div>
  } @else if (errorMessage()) {
    <div class="error-banner">
      <div class="error-banner__content">
        <i class="pi pi-exclamation-circle"></i>
        <span>{{ errorMessage() }}</span>
      </div>
      <p-button label="Retry Connection" icon="pi pi-refresh" severity="danger" size="small" [text]="true" (onClick)="loadPatients()" />
    </div>
  }


  <!-- Feedback Toast -->
  <p-toast />

  <!-- Confirmation Dialog -->
  <p-confirmDialog />

  <!-- Action Menu -->
  <p-menu #menu [model]="userMenuItems" [popup]="true" appendTo="body" />

  <!-- Edit User Dialog -->
  <p-dialog 
    header="Edit User Information" 
    [visible]="showEditDialog()" 
    (visibleChange)="showEditDialog.set($event)"
    [modal]="true" 
    [style]="{ width: '400px' }" 
    [draggable]="false"
    [resizable]="false"
    class="edit-dialog"
  >
    @if (editingUser()) {
      <div class="dialog-content">
        <div class="input-group">
          <label for="firstName">First Name</label>
          <input 
            pInputText 
            id="firstName" 
            [(ngModel)]="editingUser()!.firstName" 
            placeholder="Enter first name"
          />
        </div>
        <div class="input-group">
          <label for="lastName">Last Name</label>
          <input 
            pInputText 
            id="lastName" 
            [(ngModel)]="editingUser()!.lastName" 
            placeholder="Enter last name"
          />
        </div>
        <div class="input-group">
          <label for="age">Age</label>
          <p-inputNumber 
            id="age" 
            [(ngModel)]="editingUser()!.age" 
            [min]="0" 
            [max]="150"
            placeholder="Enter age"
          />
        </div>
      </div>
    }
    <ng-template pTemplate="footer">
      <div class="dialog-footer">
        <p-button 
          label="Cancel" 
          [text]="true" 
          severity="secondary"
          (onClick)="showEditDialog.set(false)" 
        />
        <p-button 
          label="Save Changes" 
          icon="pi pi-check" 
          [loading]="isUpdating()" 
          (onClick)="savePatient()" 
        />
      </div>
    </ng-template>
  </p-dialog>

  <!-- User Directory -->
  <section class="directory-section">
    <div class="directory-header">
      <h2 class="directory-title">User Directory</h2>
      <div class="directory-actions">
        <p-button
          label="Filter"
          icon="pi pi-filter"
          [outlined]="true"
          severity="secondary"
          (onClick)="onFilter()"
        />
        <p-button
          label="Export"
          icon="pi pi-download"
          [outlined]="true"
          severity="secondary"
          (onClick)="onExport()"
        />
      </div>
    </div>

    <div class="directory-table-wrap">
      <table class="directory-table">
        <thead>
          <tr>
            <th>USER</th>
            <th>CONTACT EMAIL</th>
            <th>ROLE</th>
            <th>STATUS</th>
            <th>LAST ACTIVITY</th>
            <th>ACTIONS</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users(); track user.id) {
            <tr>
              <td>
                <div class="user-cell">
                  <p-avatar
                    [image]="user.avatar"
                    [label]="user.avatar ? '' : getInitials(user.name)"
                    shape="circle"
                    size="normal"
                    [styleClass]="'user-avatar ' + (user.avatar ? '' : user.avatarBg)"
                  />
                  <div class="user-cell__info">
                    <span class="user-name">{{ user.name }}</span>
                    <span class="user-id">ID: #{{ user.id }}</span>
                  </div>
                </div>
              </td>
              <td><span class="email-cell">{{ user.email }}</span></td>
              <td>
                <span
                  class="role-pill"
                  [class.role-pill--caregiver]="user.role === 'Caregiver'"
                  [class.role-pill--patient]="user.role === 'Patient'"
                  [class.role-pill--staff]="user.role === 'Staff'"
                >
                  {{ user.role }}
                </span>
              </td>
              <td>
                <span
                  class="status-pill"
                  [class.status-pill--active]="user.status === 'Active'"
                  [class.status-pill--offline]="user.status === 'Offline'"
                >
                  <span class="status-dot"></span>
                  {{ user.status }}
                </span>
              </td>
              <td><span class="activity-cell">{{ user.lastActivity }}</span></td>
              <td>
                <div class="actions-cell">
                  <button 
                    type="button" 
                    class="action-icon-btn" 
                    aria-label="Actions"
                    (click)="activeUser = user; menu.toggle($event)"
                  >
                    <i class="pi pi-ellipsis-v"></i>
                  </button>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <div class="pagination-bar">
      <span class="pagination-info">Showing {{ first() + 1 }}-{{ first() + rows() }} of {{ total() }} users</span>
      <div class="pagination-controls">
        <button
          type="button"
          class="page-btn"
          [disabled]="first() === 0"
          (click)="prevPage()"
          aria-label="Previous page"
        >
          <i class="pi pi-chevron-left"></i>
        </button>
        <button
          type="button"
          class="page-btn page-btn--active"
        >
          1
        </button>
        <button type="button" class="page-btn">2</button>
        <button type="button" class="page-btn">3</button>
        <span class="page-ellipsis">...</span>
        <button
          type="button"
          class="page-btn"
          [disabled]="first() + rows() >= total()"
          (click)="nextPage()"
          aria-label="Next page"
        >
          <i class="pi pi-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>
</div>
